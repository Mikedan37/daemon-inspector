name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run nightly at 2 AM UTC
    - cron: '0 2 * * *'

env:
  SWIFT_VERSION: '5.9'

jobs:
  test:
    name: Build & Test
    runs-on: macos-14
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: ${{ env.SWIFT_VERSION }}
    
    - name: Swift Version
      run: swift --version
    
    - name: Build
      run: swift build -v
    
    - name: Run Tests
      run: swift test --enable-code-coverage
      
    - name: Generate Code Coverage
      run: |
        xcrun llvm-cov export -format="lcov" \
          .build/debug/BlazeDBPackageTests.xctest/Contents/MacOS/BlazeDBPackageTests \
          -instr-profile .build/debug/codecov/default.profdata > coverage.lcov || true
        
    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage.lcov
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  lint:
    name: Lint
    runs-on: macos-14
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Swift
      uses: swift-actions/setup-swift@v1
      with:
        swift-version: ${{ env.SWIFT_VERSION }}
    
    - name: Check Swift Format
      run: |
        # Basic syntax check
        swift build 2>&1 | grep -i "error:" && exit 1 || exit 0
        
    - name: Check Documentation
      run: |
        # Verify README exists and is valid
        test -f README.md || exit 1
        test -f CONTRIBUTING.md || exit 1
        test -f CHANGELOG.md || exit 1
        test -f LICENSE || exit 1

  linux-test:
    name: Linux Build & Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: ${{ env.SWIFT_VERSION }}
    
    - name: Build
      run: swift build -v
    
    - name: Run Tests
      run: swift test
